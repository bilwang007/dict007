# Database-First Lookup with User Editing & Admin Approval

## Overview

This feature implements a database-first lookup system where:
1. **Database is checked first** - Definitions are retrieved from the database before calling the LLM
2. **Users can edit definitions** - Users can customize definitions for themselves
3. **Admin approval system** - Admins can review conflicting definitions and choose which to keep

## Features

### 1. Database-First Lookup
- When a word is searched, the system first checks the database
- If found, returns immediately (fast response)
- If not found, generates with LLM and saves to database for future use
- Significantly reduces LLM API calls and improves response time

### 2. User Definition Editing
- Users can edit any definition for their personal use
- Edits are stored separately and only visible to the user
- Users can revert to the original definition at any time
- Edit button appears on result cards when a definition exists in the database

### 3. Admin Approval System
- When multiple definitions exist for the same word, admins can review them
- Admins can approve one definition (others are automatically rejected)
- Pending definitions are created when users propose new definitions
- Admin interface at `/admin/definitions`

## Database Schema

### New Tables

1. **word_definitions** - Stores approved definitions
   - One approved definition per word+language pair
   - Status: `pending`, `approved`, or `rejected`
   - Tracks who created and approved each definition

2. **user_definition_edits** - Stores user-specific customizations
   - One edit per user per definition
   - Users can override any field (definition, examples, usage note)

### Migration

Run the SQL migration file:
```bash
# In Supabase SQL Editor or psql
psql -U your_user -d your_database -f database-migration-word-definitions.sql
```

Or copy the contents of `database-migration-word-definitions.sql` into Supabase SQL Editor.

## Setup Instructions

### Step 1: Run Database Migration

1. Go to your Supabase project dashboard
2. Navigate to SQL Editor
3. Copy and paste the contents of `database-migration-word-definitions.sql`
4. Run the migration
5. Verify tables were created:
   - `word_definitions`
   - `user_definition_edits`
   - `user_profiles` should now have a `role` column

### Step 2: Set Up Admin User

To make a user an admin, update their profile in Supabase:

```sql
UPDATE user_profiles
SET role = 'admin'
WHERE id = 'user-id-here';
```

Or via Supabase dashboard:
1. Go to Table Editor → `user_profiles`
2. Find your user
3. Set `role` to `admin`

### Step 3: Test the Feature

1. **Test Database-First Lookup:**
   - Search for a word (e.g., "hello")
   - First time: Generated by LLM and saved to database
   - Second time: Retrieved from database (much faster!)

2. **Test User Editing:**
   - Search for a word that exists in database
   - Click "Edit" button on the result card
   - Modify the definition
   - Click "Save for Me"
   - Search again - you should see your custom definition
   - Click "Edit" again → "Revert to Original" to restore

3. **Test Admin Approval:**
   - Login as admin
   - Go to `/admin/definitions`
   - Review pending definitions
   - Approve or reject definitions

## API Endpoints

### `/api/lookup` (POST)
- Updated to check database first
- Returns `source`: `'database'`, `'user_edit'`, or `'llm'`
- Returns `wordDefinitionId` for editing functionality

### `/api/definitions/edit` (POST)
- Save user's custom definition edit
- Body: `{ wordDefinitionId, definitionTarget, definition, ... }`

### `/api/definitions/edit` (DELETE)
- Remove user's custom edit (revert to base definition)
- Query param: `?wordDefinitionId=...`

### `/api/definitions/propose` (POST)
- Propose a new definition (creates pending definition)
- Used when user wants to suggest a different definition for all users

### `/api/admin/definitions` (GET)
- Get pending definitions for admin review
- Query param: `?status=pending`

### `/api/admin/definitions` (PUT)
- Approve or reject a definition
- Body: `{ definitionId, action: 'approve' | 'reject' }`

## User Interface

### Result Card
- **Edit Button**: Appears when `wordDefinitionId` exists
- **Source Indicator**: Shows where definition came from (database/user_edit/llm)
- **Edit Modal**: Full-featured editor for all definition fields

### Admin Page
- **Route**: `/admin/definitions`
- **Features**:
  - List all pending definitions
  - View definition details
  - Approve or reject definitions
  - See who proposed each definition

## How It Works

### Lookup Flow

```
1. User searches word
   ↓
2. Check database for approved definition
   ↓
3. If found:
   - Check for user's custom edit
   - Return user edit OR base definition
   ↓
4. If not found:
   - Generate with LLM
   - Save to database (async)
   - Return LLM result
```

### User Edit Flow

```
1. User clicks "Edit" button
   ↓
2. Edit modal opens with current definition
   ↓
3. User modifies fields
   ↓
4. User clicks "Save for Me"
   ↓
5. Edit saved to user_definition_edits table
   ↓
6. Next lookup shows user's custom definition
```

### Admin Approval Flow

```
1. User proposes new definition (via /api/definitions/propose)
   ↓
2. Definition created with status='pending'
   ↓
3. Admin views pending definitions at /admin/definitions
   ↓
4. Admin approves one definition
   ↓
5. Other pending definitions for same word are rejected
   ↓
6. Approved definition becomes the base definition for all users
```

## Benefits

1. **Performance**: Database lookups are much faster than LLM calls
2. **Cost Savings**: Reduces LLM API usage significantly
3. **User Customization**: Users can personalize definitions
4. **Quality Control**: Admin approval ensures definition quality
5. **Scalability**: Database can handle millions of definitions

## Notes

- LLM-generated definitions are auto-approved (status='approved')
- User edits are always personal (not shared with other users)
- Only one approved definition per word+language pair
- Admins can see all definitions (pending, approved, rejected)
- Regular users can only see approved definitions

## Troubleshooting

### Edit button not showing
- Make sure the word exists in the database
- Check that `wordDefinitionId` is returned in lookup response

### Admin page shows "Checking permissions"
- Verify user has `role='admin'` in `user_profiles` table
- Check that RLS policies allow admin access

### Definitions not saving
- Check Supabase RLS policies
- Verify user is authenticated
- Check browser console for errors

## Future Enhancements

- Bulk approval/rejection
- Definition version history
- User voting on definitions
- Definition quality scores
- Automatic definition merging

